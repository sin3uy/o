<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استبيان</title>
    <style>
        #responseMessage {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f1f1f1;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>استبيان</h1>
    <form id="surveyForm">
        <label for="name">الاسم:</label>
        <input type="text" id="name" required><br><br>

        <label for="age">العمر:</label>
        <input type="number" id="age" required><br><br>

        <label for="institute">اختر المعهد/الكلية:</label>
        <select id="institute" required>
            <option value="">-- اختر --</option>
            <option value="معهد فني تمريض قناه السويس">معهد فني تمريض قناه السويس</option>
            <option value="كليه تمريض قناه السويس">كليه تمريض قناه السويس</option>
        </select><br><br>

        <label for="governorate">اختر محافظتك:</label>
        <input type="text" id="governorate" placeholder="ادخل محافظتك" required><br><br>

        <label>هل أنت طالب في الجامعة الآن؟</label><br>
        <input type="radio" id="studentYes" name="isStudent" value="نعم" required>
        <label for="studentYes">نعم</label><br>
        <input type="radio" id="studentNo" name="isStudent" value="لا">
        <label for="studentNo">لا</label><br><br>

        <label>اختر الجنس:</label><br>
        <input type="radio" id="male" name="gender" value="طالب" required>
        <label for="male">طالب</label><br>
        <input type="radio" id="female" name="gender" value="طالبة">
        <label for="female">طالبة</label><br><br>

        <label for="query">الاستفسار:</label>
        <textarea id="query" required></textarea><br><br>

        <button type="submit">إرسال</button>
    </form>

    <div id="responseMessage">
        <h2>الرد على استفسارك:</h2>
        <p id="responseText"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGWjR8bISWoGD1sY0aPy-dbOPYBMcASBg",
            authDomain: "chat-3929d.firebaseapp.com",
            databaseURL: "https://chat-3929d-default-rtdb.firebaseio.com",
            projectId: "chat-3929d",
            storageBucket: "chat-3929d.appspot.com",
            messagingSenderId: "496799977662",
            appId: "1:496799977662:web:3a8b850c19aba2a72b0eef",
            measurementId: "G-HMFGJY8ZYF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const surveyForm = document.getElementById('surveyForm');
        const responseMessage = document.getElementById('responseMessage');
        const responseText = document.getElementById('responseText');

        // Check if there is saved user data in localStorage
        const savedSurveyKey = localStorage.getItem('surveyKey');
        if (savedSurveyKey) {
            // Fetch and display the saved response for this user
            displayResponse(savedSurveyKey);
        }

        // Function to display response
        function displayResponse(surveyKey) {
            const responseRef = ref(database, `surveys/${surveyKey}/response`);
            onValue(responseRef, (snapshot) => {
                const response = snapshot.val();
                if (response) {
                    responseText.innerText = response;
                    responseMessage.style.display = 'block';
                }
            });
        }

        // Handle form submission
        surveyForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            const institute = document.getElementById('institute').value;
            const governorate = document.getElementById('governorate').value;
            const isStudent = document.querySelector('input[name="isStudent"]:checked').value;
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const query = document.getElementById('query').value;

            // Save the data to Firebase and get the unique key for this survey
            const dbRef = ref(database, 'surveys');
            const newSurveyRef = push(dbRef, {
                name: name,
                age: age,
                institute: institute,
                governorate: governorate,
                isStudent: isStudent,
                gender: gender,
                query: query,
                response: "" // Initially no response
            });

            // Store the unique key in localStorage so we can retrieve it later
            localStorage.setItem('surveyKey', newSurveyRef.key);

            alert("تم إرسال البيانات بنجاح!");
            surveyForm.reset();

            // Start monitoring for responses to this survey
            displayResponse(newSurveyRef.key);
        });
    </script>
</body>
</html>
